<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>deep-rql.js - deepjs API</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.8.0&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="..&#x2F;assets/favicon.png">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;combo?3.8.0&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="..&#x2F;assets/css/logo.png" title="deepjs API"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.9.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/DeepHandler.html">DeepHandler</a></li>
            
                <li><a href="..&#x2F;classes/SynchHandler.html">SynchHandler</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="..&#x2F;modules/deep.html">deep</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: deep-rql.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x2F;*
 * A deep oriented implementation of RQL for JavaScript arrays based on rql&#x2F;js-array from Kris Zyp (https:&#x2F;&#x2F;github.com&#x2F;persvr&#x2F;rql).
 * For example:
 * require(&quot;deep&#x2F;deep-rql&quot;).query(&quot;a=3&quot;, {}, [{a:1},{a:3}]) -&gt; [{a:3}]

What&#x27;s different from js-array ? It could handle schema properties and ancestor access when filtering

 * @author Gilles Coomans &lt;gilles.coomans@gmail.com&gt;
 *&#x2F;

if(typeof define !== &#x27;function&#x27;){
	var define = require(&#x27;amdefine&#x27;)(module);
}
&#x2F;**
TODO : 
add distinct(testPropertyPath)
add merge()
add backgrounds()  :  do object extension with deep-extender + schema



add _ancestor (any ancestor)
add _brothers  (any brothers)

! TEST ALL operations !

*&#x2F; 
define(function defineJsonQuery(require){
	RQL_Global = {}

var layer = {};
var utils = require(&quot;deep&#x2F;utils&quot;);
var retrieveFullSchemaByPath = utils.retrieveFullSchemaByPath;
var parser = require(&quot;rql&#x2F;parser&quot;);
var parseQuery = parser.parseQuery;
var stringify = JSON.stringify || function(str){
	return &#x27;&quot;&#x27; + str.replace(&#x2F;&quot;&#x2F;g, &quot;\\\&quot;&quot;) + &#x27;&quot;&#x27;;
};

function getJSPrimitiveType(obj){
	if(obj instanceof Array || obj.push)
		return &quot;array&quot;
	return typeof obj;
}

layer.jsOperatorMap = {
	&quot;eq&quot; : &quot;===&quot;,
	&quot;ne&quot; : &quot;!==&quot;,
	&quot;le&quot; : &quot;&lt;=&quot;,
	&quot;ge&quot; : &quot;&gt;=&quot;,
	&quot;lt&quot; : &quot;&lt;&quot;,
	&quot;gt&quot; : &quot;&gt;&quot;
};

var isPresent = RQL_Global.isPresent = function isPresent(path, items){
	var res = [];
	&#x2F;&#x2F;console.log(&quot;is present : &quot;+path)
	items.forEach(function (e){	
	&#x2F;&#x2F;	console.log(&quot;got items : test : &quot; + path + &quot; - object &quot;,e);
		if(retrieve(e, path))
			res.push(e);
	});
	return res;
}



var rewritePath = RQL_Global.rewritePath = function rewritePath(path){

	var parts = path || [];
	&#x2F;&#x2F;console.log(&quot;rewrite path : &quot; +path, &quot; - prefix ? &quot;,objectPrefix)
	if(typeof parts  === &#x27;string&#x27;)
		parts = parts.split(&quot;.&quot;);
	&#x2F;&#x2F;console.log(&quot;retrieve final path : &quot; +JSON.stringify(parts))
	&#x2F;&#x2F;console.log(parts[0] != &#x27;_schema&#x27; &amp;&amp; parts[0] != &quot;_parent&quot; &amp;&amp; objectPrefix &amp;&amp; objectPrefix != &quot;&quot;)
	if(objectPrefix &amp;&amp; parts[0] != &#x27;_schema&#x27; &amp;&amp; parts[0] != &quot;_parent&quot;)
		parts.unshift(objectPrefix);	
	&#x2F;&#x2F;console.log(&quot;rewrited path : &quot;,JSON.stringify(parts))
	return parts;
}
&#x2F;*
retrieve schema property
*&#x2F;
var retrieveSchemaProp = RQL_Global.retrieveSchemaProp = function retrieveSchemaProp(path, schema, parts, obj){
	&#x2F;&#x2F;console.log(&quot;retrieveSchemaProp of : &quot;,path, &quot; - parts : &quot;, parts, &quot; - schema : &quot;, schema)
	&#x2F;&#x2F;return schema || {};
	if(parts[0] == &quot;_schema&quot;)
		parts.shift();
	var tmp = schema;
	if(!schema)
		&#x2F;&#x2F;tmp = retrieveFullSchemaByPath(schema, parts.join(&quot;.&quot;));
	&#x2F;&#x2F;else 
	{
		if(parts.length == 1 &amp;&amp; parts[0] == &quot;type&quot;)
		{
			&#x2F;&#x2F;console.log(&quot;no schema but need type : produce it : &quot;,typeof obj)
			parts.shift();
			return getJSPrimitiveType(obj);
		}
		else if(parts.length == 1 &amp;&amp; parts[0] == &quot;depth&quot;)
		{
			&#x2F;&#x2F;console.log(&quot;no schema but need type : produce it : &quot;,typeof obj)
			parts.shift();
			return path.split(&quot;&#x2F;&quot;).length;
		}
		else if(parts.length == 1 &amp;&amp; parts[0] == &quot;class&quot;)
		{
			&#x2F;&#x2F;console.log(&quot;no schema but need type : produce it : &quot;,typeof obj)
			parts.shift();
			return utils.getObjectClass(obj);
		}
	}
	if(parts.length == 0 || !tmp)
		return tmp || {};
	var propSchema = utils.retrieveValueByPath(tmp, parts.join(&quot;.&quot;));
	 if(!propSchema &amp;&amp; parts.length == 1 &amp;&amp; parts[0] == &quot;type&quot;)
	 {
	 	parts.shift();
		return getJSPrimitiveType(obj);
	 }	
	 return propSchema;
}

var retrieveParent = RQL_Global.retrieveParent = function retrieveParent(obj, parts, count)
{
	var tmp = obj;
	&#x2F;&#x2F;console.log(&quot;RETREIEVE PARENT : &quot;, tmp.value, count)
	while(tmp.ancestor &amp;&amp; count &gt; 0)
	{
		tmp = tmp.ancestor;
		count--;
	}
	&#x2F;&#x2F;tmp = tmp.value;
	if(count != 0)
		tmp = null;
	&#x2F;&#x2F;console.log(&quot;retrieve parent got :&quot;, tmp)

	return tmp;
}
var dicoRetrieve = {};
var getRetrieveFunc = RQL_Global.getRetrieveFunc = function getRetrieveFunc(path)
{
	if(dicoRetrieve[path])
		return dicoRetrieve[path];
	&#x2F;&#x2F;console.log(&quot;deep-rql : get retrieve func : &quot;, path, parts)
	
	var func = &quot;&quot;;
	var parts = rewritePath(path);
	if(parts.length == 0)
	{
		&#x2F;&#x2F;func = &quot;(function applyEvaluatedRetrieve(object){return object;})&quot;;
	&#x2F;&#x2F;	console.log(&quot;function evaluation retrieve : &quot;,func);
		return dicoRetrieve[path] = new Function(&quot;object&quot;, &quot;return object;&quot;);
	}	
	
	if(parts[0] == &#x27;_parent&#x27;)
	{
		var count = 0;
		while(parts.length &gt; 0 &amp;&amp; parts[0] == &quot;_parent&quot;)
		{
			count++;
			parts.shift();
		}	

		func += &quot;object = RQL_Global.retrieveParent(object, null, &quot;+count+&quot;); if(object == null) return null; &quot;;
		&#x2F;&#x2F;console.log(&quot;will get parent with : &quot;, func)
		if(parts.length == 0)
		{
			func += &quot;return object;&quot;;
			&#x2F;&#x2F;console.log(&quot;function evaluation (with parent) : &quot;,func);
			return dicoRetrieve[path] = new Function(&quot;object&quot;,func);
		}	
		if(objectPrefix &amp;&amp; parts[0] != &quot;_schema&quot;)
			parts.unshift(objectPrefix)
	}
	if(parts[0] == &quot;_schema&quot;)
	{
		&#x2F;&#x2F;console.log(&quot;RETRIEVE SCHEMA&quot;);
		parts.shift();
		func += &quot;var res = RQL_Global.retrieveSchemaProp(object.path, object.schema, [&#x27;&quot;+parts.join(&quot;&#x27;][&#x27;&quot;)+&quot;&#x27;], &quot;+((objectPrefix)?(&quot;object[&#x27;&quot;+objectPrefix+&quot;&#x27;]&quot;):&quot;object&quot;)+&quot;); return res;&quot;;
		&#x2F;&#x2F;func += &quot;console.log(&#x27;result of retrieve schema prop : &#x27;,res);&quot;
		&#x2F;&#x2F;func  = &quot;(function applyEvaluatedRetrieve(object){&quot;+func+&quot;})&quot;;
		&#x2F;&#x2F;console.log(&quot;function evaluation (with direct schema) : &quot;+func);
		var evaluated = new Function(&quot;object&quot;, func);
		dicoRetrieve[path] = evaluated;
		return evaluated; &#x2F;*dicoRetrieve[path] = function applyEvaluatedRetrieve(object){
			evaluated(object, parts);
		}*&#x2F;
	}
	func += &quot;var fullPath = object.path;&quot;;
	&#x2F;&#x2F;var currentPath = [tmp.path];
	var part = parts[0];
	var escaped = [];
	&#x2F;&#x2F;var unescaped = [];
	var item = &quot;object&quot;;
	var schemaEnd = false;
	var escapedJoined = &quot;&quot;;
	for(var i = 0; parts.length &gt; 0; i++)
	{
		part = parts.shift();
		escaped.push(part);
		escapedJoined = escaped.join(&quot;&#x27;][&#x27;&quot;);
		if(part != &quot;_schema&quot;)
			item +=&quot;&amp;&amp;object[&#x27;&quot; + escapedJoined + &quot;&#x27;]&quot;;
		else
		{
			func += &quot;if(&quot;+item+&quot;) object = object[&#x27;&quot;+ escapedJoined + &quot;&#x27;]; else return null;&quot; ;
			func += &quot;return RQL_Global.retrieveSchemaProp(fullPath+&#x27;.&quot;+escaped.join(&quot;.&quot;)+&quot;&#x27;, object.schema, [&#x27;&quot;+parts.join(&quot;&#x27;][&#x27;&quot;)+&quot;&#x27;], object);&quot;;
			schemaEnd = true;
			break;
		}
	}
	if(!schemaEnd)
		func += &quot;if(&quot;+item+&quot;) return object[&#x27;&quot;+ escapedJoined + &quot;&#x27;]; else return null;&quot;;
	&#x2F;&#x2F;console.log(&quot;function evaluation retrieve : &quot;,func);
	var evaluated = new Function(&quot;object&quot;,func);
	return dicoRetrieve[path] = evaluated;
}
var retrieve = function retrieve(object, path)
{
	&#x2F;&#x2F;console.log(&quot;retrieve : path : &quot; ,path , &quot; - &quot;,object);
	var res = getRetrieveFunc(path)(object);
	&#x2F;&#x2F;console.log(&quot;retrieve got : &quot;, res)
	return res;
}
RQL_Global.retrieve = retrieve;

layer.instanceOfs = {
	&quot;Array&quot;:{}
}


layer.operators = {
	sort: function rqlSort(){
		var terms = [];
		for(var i = 0; i &lt; arguments.length; i++){
			var sortAttribute = arguments[i];
			var firstChar = sortAttribute.charAt(0);
			var term = {attribute: sortAttribute, ascending: true};
			if (firstChar == &quot;-&quot; || firstChar == &quot;+&quot;) {
				if(firstChar == &quot;-&quot;)
					term.ascending = false;
				term.attribute = term.attribute.substring(1);
			}
			terms.push(term);
		}
		this.sort(function(a, b){
			for (var term, i = 0; term = terms[i]; i++) {
				var ar = retrieve(a, term.attribute);
				var br = retrieve(b, term.attribute);
				if (ar != br)
					return term.ascending == ar &gt; br ? 1 : -1;
			}
			return 0;
		});
		return this;
	},
	match: filter(function rqlMatch(value, regex){
		return new RegExp(regex).test(retrieve(value));
	}),
	&quot;instanceOf&quot;: function rqlInstanceOf(value, values){
		&#x2F;&#x2F;console.log(&quot;IN OP : query &quot;+value+&quot; in : &quot;,values)
		var ok = false;
		var count = 0;
		for(var i in values)
		{
			if(layer.instanceOfs &amp;&amp; layer.instanceOfs[i])
				ok = ok &amp;&amp; layer.instanceOfs[i](value);
			else
				ok = false;
			if(!ok)
				break;
		}
		return ok;
	},
	&quot;in&quot;: filter(function rqlIn(value, values){
		&#x2F;&#x2F;console.log(&quot;IN OP : query &quot;+value+&quot; in : &quot;,values)
		var ok = false;
		var count = 0;
		while(!ok &amp;&amp; count &lt; values.length)
			if(values[count++] == value)
				ok = true;
		return ok;
	}),
	out: filter(function rqlOut(value, values){
		var ok = true;
		var count = 0;
		while(ok &amp;&amp; count &lt; values.length)
			if(values[count++] == value)
				ok = false;
		return ok;
	}),
	contains: filter(function rqlContains(array, value){
		&#x2F;&#x2F;console.log(&quot;rql : contains : &quot;, array, value)
		if(typeof value == &quot;function&quot;){
			if(array instanceof Array)
				return array.some(function(v){
					var r = retrieve(value);
					if(r)
						return r.call([v]).length;
					return false;
				});
			else
				return false;
		}
		else{
			if(!(array instanceof Array ))
				return false;
			var ok = false;
			var count = 0;
			while(!ok &amp;&amp; count &lt; array.length)
				if(array[count++] == value)
					ok = true;
			return ok;
		}
	}),
	excludes: filter(function rqlExcludes(array, value){
		if(!(array instanceof Array ))
				return false;
		if(typeof value == &quot;function&quot;){
			return !array.some(function(v){
				var r = retrieve(value);
				if(r)
					return r.call([v]).length;
				return false;
			});
		}
		else{
			var ok = true;
			var count = 0;
			while(!ok &amp;&amp; count &lt; array.length)
				if(array[count++] == value)
					ok = false;
			return ok;
		}
	}),
	or: function rqlOr(){
		var items = [];
		&#x2F;&#x2F;TODO: remove duplicates and use condition property
		for(var i = 0; i&lt; arguments.length; ++i){
			if(typeof arguments[i] == &#x27;function&#x27;)
				items = items.concat(arguments[i].call(this));
			else
				items = items.concat(isPresent(arguments[i], items))

		}
		return items;
	},
	and: function rqlAnd(){
		var items = this;
	&#x2F;&#x2F;	console.log(&quot;rqlAnd : &quot;, arguments);
		&#x2F;&#x2F; TODO: use condition property
		for(var i = 0; i&lt; arguments.length; ++i){
			&#x2F;&#x2F;console.log(&quot;and call args : &quot;+i+ &quot; - &quot;+arguments[i]);
		&#x2F;&#x2F;	console.log(&quot;and call args : items : &quot;, items);
			if(typeof arguments[i] == &#x27;function&#x27;)
				items = arguments[i].call(items);
			else &#x2F;&#x2F;if(typeof arguments[i] === &#x27;string&#x27;)
				items = isPresent(arguments[i], items);
		}
		return items;
	},
	select: function rqlSelect(){
		var args = arguments;
		var argc = arguments.length;
		return this.map(function(object){
			var selected = {};
			for(var i = 0; i &lt; argc; i++){
				var propertyName = args[i];
				var value = evaluateProperty(object, propertyName);
				if(typeof value != &quot;undefined&quot;){
					selected[propertyName] = value;
				}
			}
			return selected;
		});
	},
	&#x2F;* _______________________________________________ WARNING : NOT IMPLEMENTED WITH PREFIX*&#x2F;
	unselect: function rqlUnselect(){
		var args = arguments;
		var argc = arguments.length;
		return this.map(function(object){
			var selected = {};
			for (var i in object)
			 if (object.hasOwnProperty(i)) {
				selected[i] = object[i];
			}
			for(var i = 0; i &lt; argc; i++) {
				delete selected[args[i]];
			}
			return selected;
		});
	},
	values: function rqlValues(first){
		if(arguments.length == 1){
			return this.map(function(object){
				return retrieve(object, first) ;
			});
		}
		var args = arguments;
		var argc = arguments.length;
		return this.map(function(object){
			var realObject = retrieve(object);
			var selected = [];
			if (argc === 0) {
				for(var i in realObject) if (realObject.hasOwnProperty(i)) {
					selected.push(realObject[i]);
				}
			} else {
				for(var i = 0; i &lt; argc; i++){
					var propertyName = args[i];
					selected.push(realObject[propertyName]);
				}
			}
			return selected;
		});
	},
	limit: function rqlLimit(limit, start, maxCount){
		var totalCount = this.length;
		start = start || 0;
		var sliced = this.slice(start, start + limit);
		if(maxCount){
			sliced.start = start;
			sliced.end = start + sliced.length - 1;
			sliced.totalCount = Math.min(totalCount, typeof maxCount === &quot;number&quot; ? maxCount : Infinity);
		}
		return sliced;
	},
	distinct: function rqlDistinct()
	{
		var primitives = {};
		var needCleaning = [];
		var newResults = this.filter(function(value){
			&#x2F;&#x2F;console.log(&quot;distinct : value : &quot;,value);

			value = retrieve(value);
			&#x2F;&#x2F;console.log(&quot;distinct : value : &quot;,value);
			if(value &amp;&amp; typeof value == &quot;object&quot;){
				if(!value.__found__){
					value.__found__ = function(){};&#x2F;&#x2F; get ignored by JSON serialization
					needCleaning.push(value);
					return true;
				}
				return false;
			}else{
				&#x2F;&#x2F;console.log(&quot;found primitive : &quot;+value + &quot; - &quot;+JSON.stringify(primitives))
				if(!primitives[value]){
					&#x2F;&#x2F;console.log(&quot;primitive was not there&quot;)
					primitives[value] = true;
					return true;
				}
				return false;
			}
		});
		needCleaning.forEach(function(object){
			delete object.__found__;
		});
		return newResults;
	},
	recurse: function rqlRecurse(property){
		&#x2F;&#x2F; TODO: this needs to use lazy-array
		var newResults = [];
		function recurse(value){
			if(value instanceof Array){
				value.forEach(recurse);
			}else{
				newResults.push(value);
				if(property){
					value = value[property];
					if(value &amp;&amp; typeof value == &quot;object&quot;){
						recurse(value);
					}
				}else{
					for(var i in value){
						if(value[i] &amp;&amp; typeof value[i] == &quot;object&quot;){
							recurse(value[i]);
						}
					}
				}
			}
		}
		recurse(retrieve(this));
		return newResults;
	},
	aggregate: function rqlAggregate(){
		var distinctives = [];
		var aggregates = [];
		for(var i = 0; i &lt; arguments.length; i++){
			var arg = arguments[i];
			if(typeof arg === &quot;function&quot;){
				 aggregates.push(arg);
			}else{
				distinctives.push(arg);
			}
		}
		var distinctObjects = {};
		var dl = distinctives.length;
		this.forEach(function(object){
			object = retrieve(object);
			var key = &quot;&quot;;
			for(var i = 0; i &lt; dl;i++){
				key += &#x27;&#x2F;&#x27; + object[distinctives[i]];
			}
			var arrayForKey = distinctObjects[key];
			if(!arrayForKey){
				arrayForKey = distinctObjects[key] = [];
			}
			arrayForKey.push(object);
		});
		var al = aggregates.length;
		var newResults = [];
		for(var key in distinctObjects){
			var arrayForKey = distinctObjects[key];
			var newObject = {};
			for(var i = 0; i &lt; dl;i++){
				var property = distinctives[i];
				newObject[property] = arrayForKey[0][property];
			}
			for(var i = 0; i &lt; al;i++){
				var aggregate = aggregates[i];
				newObject[i] = aggregate.call(arrayForKey);
			}
			newResults.push(newObject);
		}
		return newResults;
	},
	between: filter(function rqlBetween(value, range){
		value = retrieve(value);
		return value &gt;= range[0] &amp;&amp; value &lt; range[1];
	}),
	sum: reducer(function rqlSum (a, b){
		var a= retrieve(a);
		var b = retrieve(b);
		return a + b;
	}),
	mean: function rqlMean(property){
		return layer.operators.sum.call(this, property)&#x2F;this.length;
	},
	max: reducer(function rqlMax(a, b){
		var a= retrieve(a);
		var b = retrieve(b);
		return Math.max(a, b);
	}),
	min: reducer(function rqlMin(a, b){
		var a= retrieve(a);
		var b = retrieve(b);
		return Math.min(a, b);
	}),
	count: function rqlCount(){
		return this.length;
	},
	first: function rqlFirst(){
		return this[0];
	},
	last: function rqlLast(){
		return this[this.length-1];
	},
	random: function rqlRandom(){
		return this[Math.round(Math.random()*(this.length-1))];
	},
	one: function rqlOne(){
		if(this.length &gt; 1)
			throw new TypeError(&quot;More than one object found&quot;);
		return this[0];
	}
};
layer.filter = filter;
function filter(condition, not){
	&#x2F;&#x2F; convert to boolean right now
	var filter = function doFilter(property, second){
		if(typeof second == &quot;undefined&quot;){
			second = property;
			property = undefined;
		}
		var args = arguments;
		var filtered = [];
		for(var i = 0, length = this.length; i &lt; length; i++){
			var item = this[i];
			if(condition(evaluateProperty(item, property), second)){
				filtered.push(item);
			}
		}
		return filtered;
	};
	filter.condition = condition;
	return filter;
};
function reducer(func){
	return function(property){
		if(property){
			return this.map(function(object){
				return retrieve(object, property);
			}).reduce(func);
		}else{
			return this.reduce(func);
		}
	}
}
layer.evaluateProperty = evaluateProperty;
function evaluateProperty(object, property){
	if(property instanceof Array){
		return retrieve(object, decodeURIComponent(property));
	}else if(typeof property == &quot;undefined&quot;){
		return retrieve(object);
	}else{
		return retrieve(object, decodeURIComponent(property));
	}
};
&#x2F;*
var conditionEvaluator = layer.conditionEvaluator = function(condition){
	var jsOperator = layer.jsOperatorMap[term.name];
	if(jsOperator){
		js += &quot;(function(item){return item.&quot; + term[0] + jsOperator + &quot;parameters[&quot; + (index -1) + &quot;][1];});&quot;;
	}
	else{
		js += &quot;operators[&#x27;&quot; + term.name + &quot;&#x27;]&quot;;
	}
	return eval(js);
};*&#x2F; 
layer.executeQuery = function executeQuery(query, options, target){
	return layer.query(query, options, target);
}
layer.query = query;
layer.missingOperator = function missingOperator(operator){
	throw new Error(&quot;Operator &quot; + operator + &quot; is not defined&quot;);
}
var targetCache = null;
var targetSchema = null;
var objectPrefix = null;
var queryCache = {};


function query(target, qry, options){
	var q = qry;
	&#x2F;&#x2F;console.log(&quot;deep-rql : query : &quot;, q, options, target);
	options = options || {};
	&#x2F;&#x2F;queryCache = {};
	&#x2F;&#x2F;dicoRetrieve = {};
	
	var evaluationFunc = queryCache[q];
	if(evaluationFunc)
		return target ? evaluationFunc(target) : evaluationFunc;
	
	try{
		var query = parseQuery(q, options.parameters);
	}catch(e){
		console.log(&quot;deep-rql : parse error : &quot;, q)
		return e;
	}
	prefix = options.prefix || null;
	objectPrefix = prefix || null;
	targetSchema = options.schema || null;
	targetCache = options.cache || null;
	&#x2F;&#x2F;console.log(&quot;query : &quot;+JSON.stringify(query) + &quot; - prefix : &quot;+prefix);
	&#x2F;&#x2F;console.log(&quot;target : &quot;+JSON.stringify(target));

	&#x2F;&#x2F;if(options.keepCache == false || !queryCache)
	function t(){}
	t.prototype = layer.operators;
	var operators = new t;
	var op = function op(name){
		&#x2F;&#x2F;console.log(&quot;rqlOp: &quot;, name, &quot; - res : &quot; , operators[name] || layer.missingOperator(name))
		return operators[name] || layer.missingOperator(name);
	}
	RQL_Global.op = op;
	&#x2F;&#x2F; inherit from layer.operators
	for(var i in options.operators)
		operators[i] = options.operators[i];

	var parameters = options.parameters || [];
	var js = &quot;&quot;;
	function queryToJS(value){
		if(value &amp;&amp; typeof value === &quot;object&quot;){
			if(value instanceof Array){
				&#x2F;&#x2F;console.log(&quot;__________________ QUERY TO JS : query object is array : &quot;+JSON.stringify(value))
				return &#x27;[&#x27; + value.map(queryToJS) + &#x27;]&#x27;;
			}else{
				&#x2F;&#x2F;console.log(&quot;QUERY TO JS : query value : &quot;+JSON.stringify(value))
				var jsOperator = layer.jsOperatorMap[value.name];
				if(jsOperator)
				{
					&#x2F;&#x2F;console.log(&quot;__________________ GOT OPERTAOR : &quot;+value.name + &quot; - have prefix ? &quot;+prefix)
					var path = value.args[0];
					var target = value.args[1];
					var item = &quot;&quot;;
					if (typeof target === &quot;undefined&quot;){
						&#x2F;&#x2F;console.log(&quot;Query to js : path is not provided : &quot;+JSON.stringify(path))
						item = &quot;item&quot;;
						target = path;
						if(objectPrefix)
							item += &quot;.&quot;+objectPrefix;
					}
					else {
						&#x2F;&#x2F;console.log(&quot;Query to js : path  : &quot;+JSON.stringify(path))
						item = &quot;val&amp;&amp;val&quot;;
					}
					var condition = item + jsOperator + queryToJS(target);
					&#x2F;&#x2F;console.log(&quot;conditions : &quot;+condition)
					if (typeof Array.prototype.filter === &#x27;function&#x27;) {
						return &quot;(function applyNativeArrayFilter(){return this.filter(function(item){var val = RQL_Global.retrieve(item,&#x27;&quot;+path+&quot;&#x27;); return &quot; + condition + &quot;})})&quot;;
						&#x2F;&#x2F;???return &quot;this.filter(function(item){return &quot; + condition + &quot;})&quot;;
					} else {
						throw &quot;error : array have no filter&quot;;
						&#x2F;&#x2F;return &quot;(function(){var filtered = []; for(var i = 0, length = this.length; i &lt; length; i++){var item = this[i]; var val = retrieve(item,&#x27;&quot;+path+&quot;&#x27;); if(&quot; + condition + &quot;){filtered.push(item);}} return filtered;})&quot;;
					}
				}else{
					&#x2F;&#x2F;console.log(&quot;NO JS OPERATOR : value : &quot;, value.name)
					return &quot;(function(){&quot;
							&#x2F;&#x2F;+&quot;console.log(&#x27;op ? : &#x27;, RQL_Global.op);&quot;
							&#x2F;&#x2F;+&quot;console.log(&#x27;this ? : &#x27;, this);&quot;
							+&quot;var opo = RQL_Global.op(&#x27;&quot; + value.name + &quot;&#x27;);&quot;
							&#x2F;&#x2F;+&quot;console.log(&#x27;typeof returned opo : &#x27;, typeof opo);&quot;
							&#x2F;&#x2F;+&quot;return [];&quot;
							+&quot;return opo&quot;
							+&quot;.call(this&quot; +(value &amp;&amp; value.args &amp;&amp; value.args.length &gt; 0 ? (&quot;, &quot; + value.args.map(queryToJS).join(&quot;,&quot;)) : &quot;&quot;) +&quot;)&quot;
						+&quot;})&quot;;
				}
			}
		}
		else
			return typeof value === &quot;string&quot; ? stringify(value) : value;
	}
	var evaluationString = &quot;return &quot; + queryToJS(query) + &quot;.call(target);&quot; ;
	&#x2F;&#x2F;evaluationString = &quot;(function(){ console.log(&#x27;grrrrrrrrrrr &#x27;) }).call(target); return []&quot;;
	var	toEval = new Function(&quot;target&quot;, evaluationString);
	

	&#x2F;&#x2F;console.log(&quot;EVALUATION STRING \n\n&quot;,toEval);
	&#x2F;&#x2F;var toEval = eval(evaluationString);
	queryCache[q] = toEval;
		&#x2F;&#x2F;console.log(&quot;op ? &quot;, op(&#x27;and&#x27;))
	try{
	&#x2F;&#x2F;	console.log(&quot;typeof toEval : &quot;, typeof toEval);
	&#x2F;&#x2F;	console.log(&quot;typeof target : &quot;, typeof target);
	&#x2F;&#x2F;	console.log(&quot;instance target : &quot;,  target instanceof Array);
		&#x2F;&#x2F;return (function (){return op(&#x27;and&#x27;).call(this, &quot;backgrounds&quot;)}).call(target);
		&#x2F;&#x2F;if(q == &quot;backgrounds&quot;)
		&#x2F;&#x2F;	return target ? op(&#x27;and&#x27;).call(target, &quot;backgrounds&quot;) : [];
		&#x2F;&#x2F;return toEval;
		if(target)
			return toEval(target);
		return toEval;
	}
	catch(e)
	{
		console.log(&quot;WARNING : RQL throw : &quot;,JSON.stringify(e));
		&#x2F;&#x2F;console.log(&quot;op ? &quot;, op(&#x27;and&#x27;))
		throw e;
	}
}
return layer;
});

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
