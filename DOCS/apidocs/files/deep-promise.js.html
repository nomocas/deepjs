<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>deep-promise.js - deepjs Javascript Framework</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="deepjs Javascript Framework"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.0.rc</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/deep.html">deep</a></li>
            
                <li><a href="../classes/deep.Chain.html">deep.Chain</a></li>
            
                <li><a href="../classes/deep.collider.html">deep.collider</a></li>
            
                <li><a href="../classes/deep.collider.array.html">deep.collider.array</a></li>
            
                <li><a href="../classes/deep.collider.assert.html">deep.collider.assert</a></li>
            
                <li><a href="../classes/deep.collider.object.html">deep.collider.object</a></li>
            
                <li><a href="../classes/deep.compose.html">deep.compose</a></li>
            
                <li><a href="../classes/deep.Composer.html">deep.Composer</a></li>
            
                <li><a href="../classes/deep.deep.html">deep.deep</a></li>
            
                <li><a href="../classes/deep.Deferred.html">deep.Deferred</a></li>
            
                <li><a href="../classes/deep.Promise.html">deep.Promise</a></li>
            
                <li><a href="../classes/deep.Query.html">deep.Query</a></li>
            
                <li><a href="../classes/deep.Role.html">deep.Role</a></li>
            
                <li><a href="../classes/deep.roles.html">deep.roles</a></li>
            
                <li><a href="../classes/deep.store.html">deep.store</a></li>
            
                <li><a href="../classes/deep.store.Array.html">deep.store.Array</a></li>
            
                <li><a href="../classes/deep.store.Object.html">deep.store.Object</a></li>
            
                <li><a href="../classes/deep.store.Store.html">deep.store.Store</a></li>
            
                <li><a href="../classes/deep.stores.html">deep.stores</a></li>
            
                <li><a href="../classes/deep.stores.aspect.html">deep.stores.aspect</a></li>
            
                <li><a href="../classes/deep.stores.instance.html">deep.stores.instance</a></li>
            
                <li><a href="../classes/deep.stores.js.html">deep.stores.js</a></li>
            
                <li><a href="../classes/deep.stores.queryThis.html">deep.stores.queryThis</a></li>
            
                <li><a href="../classes/deep.utils.html">deep.utils</a></li>
            
                <li><a href="../classes/deep.Validator.html">deep.Validator</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/deep.html">deep</a></li>
            
                <li><a href="../modules/deep-collider.html">deep-collider</a></li>
            
                <li><a href="../modules/deep-compose.html">deep-compose</a></li>
            
                <li><a href="../modules/deep-query.html">deep-query</a></li>
            
                <li><a href="../modules/deep-roles.html">deep-roles</a></li>
            
                <li><a href="../modules/deep-rql.html">deep-rql</a></li>
            
                <li><a href="../modules/deep-schema.html">deep-schema</a></li>
            
                <li><a href="../modules/deep-stores.html">deep-stores</a></li>
            
                <li><a href="../modules/utils.html">utils</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: deep-promise.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
if(typeof define !== &#x27;function&#x27;)
	var define = require(&#x27;amdefine&#x27;)(module);

define([&quot;require&quot;, &quot;deep/deep&quot;], function (require){

	return function(deep)
	{
	var promise = require(&quot;./promise&quot;);
	//_____________________________________________________________________ DEFERRED

	/**
	 * A deep implementation of Deferred object (see promise on web)
	 * @class deep.Deferred
	 * @constructor
	 */
	deep.Deferred = function ()
	{
		if (!(this instanceof deep.Deferred)) 
			return new deep.Deferred();
		this.context = deep.context;
		this.promises = [];
		return this;
	};

	deep.Deferred.prototype = {
		_deep_deferred_:true,
		context:null,
		promises:null,
		rejected:false,
		resolved:false,
		canceled:false,
		result:null,
		failure:null,
		/**
		 * resolve the Deferred and so the associated promise
		 * @method resolve
		 * @param  {Object} argument the resolved object injected in promise
		 * @return {deep.Deferred} this
		 */
		resolve:function (argument)
		{
			//console.log(&quot;deep.Deferred.resolve : &quot;, argument);
			if(this.rejected || this.resolved || this.canceled)
				throw new Error(&quot;DeepDeferred (resolve) has already been resolved !&quot;);
			if(argument instanceof Error)
				return this.reject(argument);

			this.result = argument;
			this.resolved = true;

			this.promises.forEach(function (promise) {
				promise.result = argument;
				promise.running = false;
				promise.resolved = true;
				nextPromiseHandler.apply(promise, [argument, null]);
			});
		},
		/**
		 * reject the Deferred and so the associated promise
		 * @method reject
		 * @param  {Object} argument the rejected object injected in promise
		 * @return {deep.Deferred} this
		 */
		reject:function (argument)
		{
		//	console.log(&quot;DeepDeferred.reject&quot;);
			if(this.rejected || this.resolved || this.canceled)
				throw new Error(&quot;DeepDeferred (reject) has already been rejected !&quot;);

			this.failure = argument;
			this.rejected = true;

			this.promises.forEach(function (promise) 
			{
				promise.failure = argument;
				promise.rejected = true;
				promise.running = false;
				nextPromiseHandler.apply(promise, [null, argument]);
			});
		},
		/**
		 * cancel the Deferred and so the associated promise
		 * @method cancel
		 * @param  {Object} reason the cancel reason object injected in promise
		 * @return {deep.Deferred} this
		 */
		cancel:function (reason)
		{
			//console.log(&quot;DeepDeferred.cancel&quot;);
			if(this.rejected || this.resolved || this.canceled)
				throw new Error(&quot;DeepDeferred (cancel) has already been canceled !&quot;);
			this.canceled =  true;
			this.promises.forEach(function (promise) {
				this.promise.canceled = true;
				this.promise.cancel();
			})
		},

		/**
		 * return a promise for this deferred
		 * @method promise
		 * @return {deep.Promise}
		 */
		promise:function () {
			var prom = new deep.Promise();
			if(this.resolved || this.rejected || this.canceled)
			{
				prom.rejected = this.rejected;
				prom.resolved = this.resolved;
				prom.canceled = this.canceled;
				prom.failure = this.failure;
				prom.result = this.result;
				prom.running = false;
				return prom;
			}
			this.promises.push(prom);
			return prom;
		}
	};
	//________________________________________________________ PROMISES
	/**
	 * a deep implementation of Promise (see web for Promise) 
	 * @namespace deep
	 * @class Promise
	 * @constructor
	 */
	deep.Promise = function ()
	{
		this.running = true;
		this.context = deep.context;
		this.queue = [];
		this._deep_promise_ = true;
	};
	deep.Promise.prototype = {
		_deep_promise_:true,
		rejected:false,
		resolved:false,
		canceled:false,
		synch:false,
		result:null,
		failure:null,
		context:null,
		/**
		 * add .done callback handler in promise chain
		 * @method done
		 * @param  {Function} argument successHandler
		 * @return {deep.Deferred} this
		 */
		done:function (callBack)
		{
			//console.log(&quot;add done in defInterface : &quot;, this.rejected, this.resolved, this.running)
			var self = this;
			var	func = function(s,e)
			{
				//console.log(&quot;deep.promise.done : &quot;,s,e)
				if(e || !callBack || s instanceof Error)
				{
					//console.log(&quot;deep.promise.done : but error : &quot;,e)
					forceNextPromiseHandler(self, s, e);
					return;
				}
				var r = callBack(s);
				if(r &amp;&amp; (r instanceof deep.Chain || r._isBRANCHES_ || r.promise))
					r = deep.promise(r);
				if(r &amp;&amp; typeof r.then === &#x27;function&#x27;)
					r.then(function (argument)
					{
						if(typeof argument === &#x27;undefined&#x27;)
							argument = s;
						forceNextPromiseHandler(self, (argument instanceof Error)?null:argument, (argument instanceof Error)?argument:null);
					}, function (error) {
						forceNextPromiseHandler(self, null, error);
					});
				else if(typeof r === &#x27;undefined&#x27;)
					forceNextPromiseHandler(self, s, e);
				else if(r instanceof Error)
					forceNextPromiseHandler(self, null, r);
				else
					forceNextPromiseHandler(self, r, null);
			};
			func._deep_done_ = true;
			this.queue.push(func);
			if((this.resolved || this.rejected))
				nextPromiseHandler.apply(this);
			return self;
		},
		/**
		 * add .fail callback handler in promise chain
		 * @method fail
		 * @param  {Function} argument successHandler
		 * @return {deep.Deferred} this
		 */
		fail:function (callBack)
		{
			var self = this;
			//console.log(&quot;add fail in defInterface&quot;)
			var func = function(s,e)
			{
				//console.log(&quot;deep.promise.fail : &quot;,s,e)
				if((e === null || typeof e === &#x27;undefined&#x27;) || !callBack)
				{
					forceNextPromiseHandler(self, s, null);
					return;
				}
				var r = callBack(e);
				if(r &amp;&amp; (r instanceof deep.Chain || r._isBRANCHES_ || r.promise))
					r = deep.when(r);
				if(r &amp;&amp; typeof r.then === &#x27;function&#x27;)
					r.then(function (argument)
					{
						if(typeof argument === &#x27;undefined&#x27;)
							forceNextPromiseHandler(self, null, e);
						else if(argument instanceof Error)
							forceNextPromiseHandler(self, null, argument);
						else
							forceNextPromiseHandler(self, argument, null);
					},function (error) {
						forceNextPromiseHandler(self, null, error);
					});
				else if(typeof r === &#x27;undefined&#x27;)
					forceNextPromiseHandler(self, null, e);
				else if(r instanceof Error)
					forceNextPromiseHandler(self, null, r);
				else
					forceNextPromiseHandler(self, r, null);
			};
			func._deep_fail_ = true;
			this.queue.push(func);
			if((this.resolved || this.rejected))
				nextPromiseHandler.apply(this);
			return self;
		},
		/**
		 * add .done and .fail in promise chain.
		 * @method then
		 * @param  {Function} sc successHandler
		 * @param  {Function} ec errorhandler
		 * @return {deep.Deferred} this
		 */
		then:function (successCallBack, errorCallBack)
		{
			var self = this;
			if(successCallBack)
				this.done(successCallBack);
			if(errorCallBack)
				this.fail(errorCallBack);
			if((this.resolved || this.rejected))
				nextPromiseHandler.apply(this);
			return self;
		},
		/**
		 * @method cancel
		 * @return {[type]}
		 */
		cancel:function(){
			console.warning(&quot;promise cancelation not yet implemented&quot;);
		}
	};
	function nextPromiseHandler(result, failure )
	{
		//console.log(&quot;nextPromiseHandler &quot;, this.running, &quot; - &quot;, this.queue, result, failure);
		if(this.running)
			return;
		this.running = true;
		var self = this;
		if((typeof failure === &#x27;undefined&#x27;) &amp;&amp; (typeof result === &#x27;undefined&#x27;))
		{
			failure = this.failure;
			result = this.result;
		}
		else
		{
			this.failure = failure;
			this.result = result;
		}
		if(result instanceof Error)
		{
			//console.log(&quot;nextPromiseHandler : result is error : &quot;,result)
			this.failure = failure = result;
			this.result = result = null;
		}
		if(this.queue.length&gt;0)
		{
			var previousContext = deep.context;
			try{

				var next = this.queue.shift();
				if(failure)
					while(next &amp;&amp; next._deep_done_)
						next = this.queue.shift();
				else
					while(next &amp;&amp; next._deep_fail_)
						next = this.queue.shift();
				if(!next)
				{
					this.running = false;
					return;
				}

				if(previousContext !== this.context)
				{
					if(previousContext &amp;&amp; previousContext.suspend)
						previousContext.suspend();
					deep.context = this.context;
					if(this.context &amp;&amp; this.context.resume)
						this.context.resume();
				}
				//console.log(&quot;newQueueThen . will try next item : &quot;,this.queue, result, failure)
				//console.log(&quot;next promise handler : &quot;, next)
				next(result,failure);
			}
			catch(e)
			{
				var msg = &quot;Internal deep.promise error : &quot;;
				//console.error(msg, e);
				if(deep.rethrow)
					throw e;
				//setTimeout(function(){
				self.running = false;
				nextPromiseHandler.apply(self, [null, e]);
				//}, 1);
			}
			finally
			{
				if(previousContext !== this.context)
				{
					if(this.context &amp;&amp; this.context.suspend)
						this.context.suspend();
					if(previousContext &amp;&amp; previousContext.resume)
						previousContext.resume();
					deep.context = previousContext;
				}
			}
		}
		else
		{
			//console.log(&quot;stopping run&quot;);
			this.running = false;
		}
	}
	function forceNextPromiseHandler(handler, s, e)
	{
		//console.log(&quot;forceNextQueue Item : &quot;, s,e)
		handler.running = false;
		nextPromiseHandler.apply(handler, [s, e]);
	}
	function createImmediatePromise(result)
	{
		//console.log(&quot;deep.createImmediatePromise : &quot;, result instanceof Error)
		var prom = new deep.Promise();
		prom.running = false;
		if(result instanceof Error)
		{
			prom.rejected = true;
			prom.failure = result;
		}
		else
		{	prom.resolved = true;
			prom.result = result;
		}
		return prom;
	}

	/**
	 * 
	 * @for deep
	 * @static 
	 * @method promise
	 * @param  {Object} arg  an object on when create a promise
	 * @return {deep.Promise} a promise
	 */
	deep.promise = function(arg)
	{
		//console.log(&quot;deep.promise : &quot;, arg)
		if(typeof arg === &quot;undefined&quot; || arg === null)
			return createImmediatePromise(arg);
		if(arg._isBRANCHES_)		// chain.branches case
			return deep.all(arg.branches);
		if(typeof arg.promise === &quot;function&quot; )  // deep.Deferred, deep.Chain and jquery deferred case
			return arg.promise();
		if(typeof arg.promise === &#x27;object&#x27;)
			return arg.promise;
		if(typeof arg.then === &#x27;function&#x27;)		//any promise compliant object
		{
			//console.log(&quot;doing simple promise (no promise and then is present) on : &quot;, arg);
			var def = deep.Deferred();
			arg.then(function(s){
				def.resolve(s);
			}, function(e){
				def.reject(e);
			})
			return def.promise();
		}	
		return createImmediatePromise(arg);
	};

	/**
	 * return a promise that will be fullfilled when arg are ready (resolve or immediat)
	 * @for deep
	 * @static 
	 * @method when
	 * @param  {Object} arg an object to waiting for
	 * @return {deep.Promise} a promise
	 */
	deep.when = deep.promise;
	/**
	 * return a promise that will be fullfilled when all args are ready (resolve or immediat)
	 * @for deep
	 * @static 
	 * @method all
	 * @param  {Object} arg an array of objects to waiting for
	 * @return {deep.Promise} a promise
	 */
	deep.all = function()
	{
		var arr = [];
		for(var i in arguments)
			arr = arr.concat(arguments[i]);
		if(arr.length === 0)
			return createImmediatePromise([]);
		var def = deep.Deferred();
		var count = arr.length;
		var c = 0, d = -1;
		var res = [];
		var rejected = false;
		arr.forEach(function (a){
			if(def.rejected)
				return;
			var i = d +1;
			if(!a || (!a.then &amp;&amp; !a.promise))
			{
				if(a instanceof Error)
				{
					rejected = true;
					if(!def.rejected &amp;&amp; !def.resolved &amp;&amp; !def.canceled)
						def.reject(a);
					return;
				}
				res[i] = a;
				c++;
				if(c == count)
					def.resolve(res);
			}
			else
				deep.when(a).then(function(r){
					if(r instanceof Error)
					{
						if(!def.rejected &amp;&amp; !def.resolved &amp;&amp; !def.canceled)
							def.reject(r);
						return;
					}
					res[i] = r;
					c++;
					if(c == count)
						def.resolve(res);
				}, function (error){
					if(!def.rejected &amp;&amp; !def.resolved &amp;&amp; !def.canceled)
						def.reject(error);
				});
			d++;
		});
		return def.promise();
	};

	promise.when = deep.when;
	promise.promise = deep.promise;
	promise.all = deep.all;

	return deep;
	}
})

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
